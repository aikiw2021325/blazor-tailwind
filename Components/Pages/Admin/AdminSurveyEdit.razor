@page "/admin/surveys/{Id:int}"
@rendermode InteractiveServer
@layout BlazorTailwindApp.Components.Layout.AdminLayout
@using BlazorTailwindApp.Models.Entities
@using BlazorTailwindApp.Models.Enums
@using BlazorTailwindApp.Services
@inject ISurveyAdminService AdminService
@inject NavigationManager Navigation

<div>
    @if (_survey == null)
    {
        <p class="text-gray-500">読み込み中...</p>
    }
    else
    {
        <div class="mb-6">
            <a href="/admin/surveys" class="text-sm text-blue-600 hover:text-blue-800">&larr; 一覧に戻る</a>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">アンケート設定</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">タイトル</label>
                    <input type="text" @bind="_survey.Title"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">説明</label>
                    <textarea @bind="_survey.Description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" @bind="_survey.IsActive" id="isActive" class="w-4 h-4" />
                    <label for="isActive" class="text-sm text-gray-700">有効</label>
                </div>
                <button @onclick="SaveSurvey"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    保存
                </button>
                @if (_savedMessage != null)
                {
                    <span class="ml-3 text-sm text-green-600">@_savedMessage</span>
                }
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-900">質問一覧</h2>
                <a href="/admin/surveys/@Id/questions/new"
                   class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-sm">
                    + 質問を追加
                </a>
            </div>

            @if (_survey.Questions.Count == 0)
            {
                <p class="text-gray-500 py-4">質問がありません。</p>
            }
            else
            {
                <div class="space-y-2">
                    @foreach (var question in _survey.Questions)
                    {
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">
                                    Step @question.Step
                                </span>
                                <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700">
                                    @GetQuestionTypeLabel(question.QuestionType)
                                </span>
                                <span class="text-gray-800">@question.Text</span>
                                @if (question.IsRequired)
                                {
                                    <span class="text-red-500 text-xs">必須</span>
                                }
                            </div>
                            <div class="flex items-center gap-2">
                                <a href="/admin/surveys/@Id/questions/@question.Id"
                                   class="text-sm text-blue-600 hover:text-blue-800">編集</a>
                                <button @onclick="() => DeleteQuestion(question.Id)"
                                        class="text-sm text-red-600 hover:text-red-800">削除</button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private Survey? _survey;
    private string? _savedMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadSurvey();
    }

    private async Task LoadSurvey()
    {
        _survey = await AdminService.GetSurveyWithQuestionsAsync(Id);
    }

    private async Task SaveSurvey()
    {
        if (_survey == null) return;
        await AdminService.UpdateSurveyAsync(_survey);
        _savedMessage = "保存しました";
        await Task.Delay(2000);
        _savedMessage = null;
        StateHasChanged();
    }

    private async Task DeleteQuestion(int questionId)
    {
        await AdminService.DeleteQuestionAsync(questionId);
        await LoadSurvey();
    }

    private string GetQuestionTypeLabel(QuestionType type) => type switch
    {
        QuestionType.SingleChoice => "単一選択",
        QuestionType.MultipleChoice => "複数選択",
        QuestionType.MatrixRating => "マトリクス",
        QuestionType.NpsScale => "NPS",
        QuestionType.BoothEvaluation => "ブース評価",
        QuestionType.FreeText => "自由記述",
        _ => type.ToString()
    };
}
